name: Build and Deploy Container to MIG

on:
  push:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - 'load-test*'

env:
  PROJECT_ID: learning-gcp-22
  REGION: asia-south1

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Get Version
        id: get_version
        run: |
          VERSION=$(jq -r .version package.json)
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      # Trigger Cloud Build to build & push Docker image
      - name: Build Docker image with Cloud Build
        run: |
          gcloud builds submit . \
            --config cloudbuild.yml \
            --substitutions=_VERSION=$VERSION \
            --project $PROJECT_ID

      - name: Create New Instance Template
        run: |
          # Sanitized version string for resource naming (replace dots with dashes)
          SAFE_VERSION=$(echo "$VERSION" | tr '.' '-')
          TEMPLATE_NAME="test-app-template-${SAFE_VERSION}"
          
          echo "Creating template: $TEMPLATE_NAME for image version: $VERSION"
          
          # Create new template using the specific versioned image
          gcloud compute instance-templates create-with-container $TEMPLATE_NAME \
            --container-image=gcr.io/$PROJECT_ID/test-app:$VERSION \
            --container-restart-policy=always \
            --container-env=VERSION=$VERSION \
            --container-host-port-mappings=8080:8080 \
            --machine-type=e2-medium \
            --tags=http-server,allow-health-check \
            --network=default \
            --service-account=test-app-sa@learning-gcp-22.iam.gserviceaccount.com \
            --scopes=https://www.googleapis.com/auth/cloud-platform \
            --boot-disk-size=10GB \
            --boot-disk-type=pd-standard \
            --image-project=cos-cloud \
            --image-family=cos-stable \
            --project=$PROJECT_ID

      - name: Update MIG to New Template
        run: |
          SAFE_VERSION=$(echo "$VERSION" | tr '.' '-')
          TEMPLATE_NAME="test-app-template-${SAFE_VERSION}"
          
          echo "Updating MIG test-app-mig to use template: $TEMPLATE_NAME"
          
          gcloud compute instance-groups managed set-instance-template test-app-mig \
            --template=$TEMPLATE_NAME \
            --zone=$REGION-c \
            --project=$PROJECT_ID
            
          echo "Updating MIG test-app-mig to use template: $TEMPLATE_NAME"

          gcloud compute instance-groups managed rolling-action start-update test-app-mig \
            --version=template=$TEMPLATE_NAME \
            --zone=$REGION-c \
            --project=$PROJECT_ID
